<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=UTF-8">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#include "game.h"
</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">11</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">// Must be an odd number
</span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// Start angle. Must match start direction vector
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">score</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">health</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">displayCol</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">game</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">chosenLevel</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">[</span><span class="sc4">32</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">obstructionsRemaining</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">SQRT2HALF</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xB504</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
    Calculate the position for the ball
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">calculateNextPosition</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">position</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">direction</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">nextPosition</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">position</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">position</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">// times 1/2 for correction of the uneven pixel density of the console
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">mainGame</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Game variables 
</span><span class="sc0">    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">menuKeyDebounce</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">150</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">ballUpdatePeriodTime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">strikerUpdatePeriod</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">displayUpdatePeriod</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">videoBufferUpdate</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1000</span><span class="sc10">;</span><span class="sc0">
    

    </span><span class="sc2">// initialize vectors
</span><span class="sc0">    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc11">currentPosition</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">initVector</span><span class="sc10">(&amp;</span><span class="sc11">direction</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">initVector</span><span class="sc10">(&amp;</span><span class="sc11">currentPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">initVector</span><span class="sc10">(&amp;</span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc2">// Clears the screen and draws the boundaries 
</span><span class="sc0">    </span><span class="sc11">clearScreen</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">setColor</span><span class="sc10">(</span><span class="sc4">36</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">40</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">drawBoundaries</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc2">// Init keys
</span><span class="sc0">    </span><span class="sc11">initKeys</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">initTimer0</span><span class="sc10">();</span><span class="sc0">
    
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// Print out menu
</span><span class="sc0">        </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">60</span><span class="sc10">,</span><span class="sc4">12</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">setColor</span><span class="sc10">(</span><span class="sc11">blueTextColor</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">backgroundColor</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"START GAME"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">60</span><span class="sc10">,</span><span class="sc4">15</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Level:  %02d"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">chosenLevel</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Left button   -   Lower level"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Right button  -   Higher level"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Center button -   Start game"</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">// Menu options
</span><span class="sc0">        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">game</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">displayScore</span><span class="sc10">(</span><span class="sc11">displayUpdatePeriod</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">// Display score on LEDs 
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">isLeftKeyPressed</span><span class="sc10">()==</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">getTimer0</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">menuKeyDebounce</span><span class="sc10">){</span><span class="sc0">
                </span><span class="sc11">resetTimer0</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">chosenLevel</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">chosenLevel</span><span class="sc10">--;</span><span class="sc0">
                    </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">68</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%02d"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">chosenLevel</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">isRightKeyPressed</span><span class="sc10">()==</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">getTimer0</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">menuKeyDebounce</span><span class="sc10">){</span><span class="sc0">
                </span><span class="sc11">resetTimer0</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">chosenLevel</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">NUMBEROFLEVELS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">chosenLevel</span><span class="sc10">++;</span><span class="sc0">
                    </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">68</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%02d"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">chosenLevel</span><span class="sc10">);</span><span class="sc0">                    
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc2">// Start game on enter key press
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">isEnterKeyPressed</span><span class="sc10">()==</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">getTimer0</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">menuKeyDebounce</span><span class="sc10">){</span><span class="sc0">
                </span><span class="sc11">resetTimer0</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">game</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// Load level from ROM and draw it 
</span><span class="sc0">        </span><span class="sc11">loadLevelFromROM</span><span class="sc10">(</span><span class="sc11">levelROM</span><span class="sc10">[</span><span class="sc11">chosenLevel</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">);</span><span class="sc0">      
        </span><span class="sc11">drawObstructions</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc11">drawStriker</span><span class="sc10">(</span><span class="sc11">strikerWidth</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Set start position and direction of the ball
</span><span class="sc0">        </span><span class="sc11">resetPositions</span><span class="sc10">(&amp;</span><span class="sc11">currentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nextPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">direction</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">health</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">drawGameStats</span><span class="sc10">(</span><span class="sc11">health</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">obstructionsRemaining</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">// Game play
</span><span class="sc0">        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">game</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">displayScore</span><span class="sc10">(</span><span class="sc11">displayUpdatePeriod</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">// Striker movement
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">getTimer0</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">strikerUpdatePeriod</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">strikerUpdatePeriod</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">25</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">isLeftKeyPressed</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">drawStriker</span><span class="sc10">(</span><span class="sc11">strikerWidth</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">strikerPosition</span><span class="sc10">--;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0"> 
                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">isRightKeyPressed</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">WIDTH</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">drawStriker</span><span class="sc10">(</span><span class="sc11">strikerWidth</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">  
                    </span><span class="sc11">strikerPosition</span><span class="sc10">++;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc2">// Update video buffer
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">videoBufferUpdate</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">1000</span><span class="sc10">){</span><span class="sc0">  </span><span class="sc2">// Update video buffer approx every second
</span><span class="sc0">                </span><span class="sc11">insertInVideoBuffer</span><span class="sc10">(</span><span class="sc11">score</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">videoBufferUpdate</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            

            </span><span class="sc2">// Ball movement
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">getTimer0</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">ballUpdatePeriodTime</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">resetTimer0</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">strikerUpdatePeriod</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">displayUpdatePeriod</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">score</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ballUpdatePeriodTime</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">videoBufferUpdate</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ballUpdatePeriodTime</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// =&gt; updating approx every second
</span><span class="sc0">
                </span><span class="sc2">// Calculate the new position
</span><span class="sc0">                </span><span class="sc11">calculateNextPosition</span><span class="sc10">(&amp;</span><span class="sc11">currentPosition</span><span class="sc10">,&amp;</span><span class="sc11">direction</span><span class="sc10">,&amp;</span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">   
                </span><span class="sc11">updateDirectionOnCollision</span><span class="sc10">(&amp;</span><span class="sc11">currentPosition</span><span class="sc10">,&amp;</span><span class="sc11">direction</span><span class="sc10">,&amp;</span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc11">updateBallOnScreen</span><span class="sc10">(&amp;</span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">currentPosition</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    Display the score on the LEDs
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">displayScore</span><span class="sc10">(</span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">displayUpdatePeriod</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Display score
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0"> 
        </span><span class="sc11">updateDisplay</span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">displayCol</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">displayUpdatePeriod</span><span class="sc10">++;</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">displayCol</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">displayCol</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">displayCol</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    Set the coordinates of a vector to the parsed arguments 
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">setCoordinates</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">cooridnates</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc10">(*</span><span class="sc11">cooridnates</span><span class="sc10">).</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">(*</span><span class="sc11">cooridnates</span><span class="sc10">).</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    Reset the striker to the center, and the ball just above going upwards
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">resetPositions</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">currentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">nextPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">direction</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Set start position and direction of the ball
</span><span class="sc0">    </span><span class="sc11">setCoordinates</span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WIDTH</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">28</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SQRT2HALF</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">SQRT2HALF</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">45</span><span class="sc10">;</span><span class="sc0">                                         </span><span class="sc2">// Reset the angle to 45 degrees
</span><span class="sc0">    </span><span class="sc11">calculateNextPosition</span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// Reset the striker
</span><span class="sc0">    </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WIDTH</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">drawStriker</span><span class="sc10">(</span><span class="sc11">strikerWidth</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
    Draw game obstruction on the game grid
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">drawObstructions</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Loop through each row
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">HEIGTH</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> 
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc11">obstructionsRemaining</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">drawSingleObstruction</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
    Update the ball when it hits something
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">updateDirectionOnCollision</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">position</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">direction</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">nextPosition</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Check if the the next postion is a collision with the left or right side boundaries
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">WIDTH</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">calculateNextPosition</span><span class="sc10">(</span><span class="sc11">position</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">// Check for collision with the top boundary
</span><span class="sc0">    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">;</span><span class="sc0"> 
        </span><span class="sc11">calculateNextPosition</span><span class="sc10">(</span><span class="sc11">position</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> 

    </span><span class="sc2">// Check obstuction Collision
</span><span class="sc0">    </span><span class="sc11">obstuctionCollision</span><span class="sc10">(</span><span class="sc11">position</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Debugging
</span><span class="sc0">    </span><span class="sc2">// homeCursor();
</span><span class="sc0">    </span><span class="sc2">// printf("s: %d  [%d, %d] - [%d, %d]\n", strikerPosition, roundToShort(position-&gt;x), roundToShort(position-&gt;y), roundToShort(nextPosition-&gt;x), roundToShort(nextPosition-&gt;y));
</span><span class="sc0">    
    </span><span class="sc2">// Check for collision with the striker
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">HEIGTH</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// Calculate a rounded value of the x coordinate
</span><span class="sc0">        </span><span class="sc2">// Check if the ball is inside the striker
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc2">// Change direction vector on right side furthest from the center
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">90</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">*</span><span class="sc11">angle</span><span class="sc10">)/</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">45</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> 
            </span><span class="sc2">// Change direction vector when the ball hits the right side closest to the center
</span><span class="sc0">            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">6</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">90</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">120</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">4</span><span class="sc10">*</span><span class="sc11">angle</span><span class="sc10">)/</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc2">// Change direction vector when the ball hits the left side closest to the center
</span><span class="sc0">            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">90</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">120</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">4</span><span class="sc10">*</span><span class="sc11">angle</span><span class="sc10">)/</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">6</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc2">// Change direction vector on left side furthest from the center
</span><span class="sc0">            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">strikerPosition</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strikerWidth</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">90</span><span class="sc10">){</span><span class="sc0">
                        </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">*</span><span class="sc11">angle</span><span class="sc10">)/</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">45</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">rotate</span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">angle</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">angle</span><span class="sc10">/</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// Calculate the next position based on the new direction
</span><span class="sc0">        </span><span class="sc11">calculateNextPosition</span><span class="sc10">(</span><span class="sc11">position</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">// Check for passing through the lower boundary
</span><span class="sc0">    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">HEIGTH</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">health</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">health</span><span class="sc10">--;</span><span class="sc0">
            </span><span class="sc11">resetPositions</span><span class="sc10">(</span><span class="sc11">position</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">drawGameStats</span><span class="sc10">(</span><span class="sc11">health</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">obstructionsRemaining</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc2">// Tell the player he has lost a life
</span><span class="sc0">            </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">58</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">33</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"You lost a life!"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">resetTimer0</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">getTimer0</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">2000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc1">/* wait two seconds */</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">58</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">33</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">// remove the text again
</span><span class="sc0">            </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"                 "</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> 
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// Game over
</span><span class="sc0">            </span><span class="sc11">clearScreen</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">setColor</span><span class="sc10">(</span><span class="sc4">36</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">40</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">drawBoundaries</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">setColor</span><span class="sc10">(</span><span class="sc4">31</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">40</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"********* GAME OVER! **********"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">game</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    Update a obstuction when it is hit 
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">updateObstructionOnHit</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">value</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">arrayPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">bitPosition</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">value</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">value</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc2">// solid block, do nothing
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">level</span><span class="sc10">[</span><span class="sc11">arrayPosition</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">bitPosition</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// subtract 1 from the value of the hit obstruction's "life"
</span><span class="sc0">        </span><span class="sc11">drawSingleObstruction</span><span class="sc10">(</span><span class="sc11">arrayPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bitPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">[</span><span class="sc11">arrayPosition</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc11">obstructionsRemaining</span><span class="sc10">--;</span><span class="sc0">
        </span><span class="sc11">drawGameStats</span><span class="sc10">(</span><span class="sc11">health</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">obstructionsRemaining</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">obstructionsRemaining</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">clearScreen</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">setColor</span><span class="sc10">(</span><span class="sc11">blueTextColor</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">backgroundColor</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">drawBoundaries</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">54</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">setColor</span><span class="sc10">(</span><span class="sc11">greenTextColor</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">backgroundColor</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"****** YOU WON! *******"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">setCursor</span><span class="sc10">(</span><span class="sc4">48</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Press enter to start the next level"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">game</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">chosenLevel</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    Calculate the collision with the obstructions 
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">obstuctionCollision</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">currentPosition</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">direction</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Vector</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">nextPosition</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">neighbourObstruction</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// 1.15 format
</span><span class="sc0">    </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// 1.15 format
</span><span class="sc0">    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">~(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">31</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">dy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">~(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">31</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">arrayPosition</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">);</span><span class="sc0"> 
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">bitPosition</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">30</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">  </span><span class="sc2">// Divide by 8 to get the correct block. Times 2 to get the correct number of bitshifts 
</span><span class="sc0">    
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">row</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">[</span><span class="sc11">arrayPosition</span><span class="sc10">];</span><span class="sc0">                        </span><span class="sc2">// Get the row in the level grid
</span><span class="sc0">
    </span><span class="sc2">// check wether or not the next position contains an obstruction
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">row</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc11">bitPosition</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">){</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc0"> 
                </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> 
                </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> 
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> 
                </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">roundToShort</span><span class="sc10">(</span><span class="sc11">nextPosition</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> 
                </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">direction</span><span class="sc10">-&gt;</span><span class="sc11">y</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">calculateNextPosition</span><span class="sc10">(</span><span class="sc11">currentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">direction</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nextPosition</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">updateObstructionOnHit</span><span class="sc10">(((</span><span class="sc11">row</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc11">bitPosition</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">arrayPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bitPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
